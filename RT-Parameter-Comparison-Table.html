<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT åƒæ•¸å°ç…§è¡¨ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --sidebar-width: 280px; --edit-bg: #fff4e5; }
        
        /* å…¨åŸŸè¨­å®šï¼šä¿®æ­£å¯¬åº¦è¨ˆç®—å•é¡Œ (è§£æ±ºåœ–äºŒè‰²å¡Šè¶…å‡ºå•é¡Œçš„æ ¸å¿ƒ) */
        * { box-sizing: border-box; } 

        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #f4f7f9; margin: 0; display: flex; overflow: hidden; }
        
        /* å´æ¬„å°è¦½ */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; height: 100vh; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; z-index: 2000; }
        .sidebar.collapsed { margin-left: -280px; }
        
        /* æ¨™é¡Œå€åŸŸ */
        .sidebar-header { padding: 25px 20px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 5px; }
        .version-tag { font-size: 12px; font-weight: normal; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }

        .sidebar-menu { flex: 1; overflow-y: auto; padding: 10px 0; }
        .menu-item { padding: 15px 20px; cursor: pointer; color: rgba(255,255,255,0.7); border-left: 5px solid transparent; font-size: 15px; transition: 0.2s; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background: rgba(255,255,255,0.15); color: white; border-left-color: var(--accent); }
        .admin-section { padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* ä¸»å…§å®¹å€ */
        .main-wrapper { flex: 1; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; z-index: 100; }
        .top-bar { background: white; padding: 12px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .content-section { padding: 20px; display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        .query-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        
        /* é¸å–®æ¨£å¼ */
        select, input { width: 100% !important; height: 48px; display: block !important; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: white; cursor: pointer; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; text-align: center; }
        th { background: #f8fafc; padding: 15px 10px; color: #64748b; font-size: 13px; border-bottom: 2px solid #edf2f7; }
        /* ä¿®æ­£æ–‡å­—æ›è¡Œå•é¡Œ: white-space: nowrap */
        td { padding: 22px 10px; border-bottom: 1px solid #f1f5f9; font-size: 24px; font-weight: 800; color: #1a202c; white-space: nowrap; }
        .editing .editable { background: #fff4e5; border: 1px solid #f39c12 !important; cursor: pointer; }

        /* æ•¸å€¼è¦–è¦ºæ¨£å¼ */
        .val-mid { font-size: 26px; font-weight: 800; display: block; line-height: 1.1; }
        .val-range { font-size: 12px; color: #7f8c8d; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; font-weight: normal; }

        /* æ¿å…§æ§½è‰²å¡Šæ¨™ç±¤ */
        .fine-box { display: flex; align-items: center; gap: 15px; }
        .fine-select { width: 220px !important; }
        .color-badge { display: inline-flex; align-items: center; justify-content: center; padding: 10px 25px; border-radius: 8px; font-size: 20px; font-weight: 900; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 120px; }

        /* å‚™è¨»åˆ—è¡¨ */
        .note-list { list-style: none; padding: 0; }
        .note-list li { padding: 12px; border-bottom: 1px solid #edf2f7; line-height: 1.6; color: #4a5568; }
        .note-list b { color: #2c3e50; margin-right: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== Mobile / Small screen UX ===== */
        @media (max-width: 900px) {
          :root { --sidebar-width: 280px; }
          body { overflow: auto; }
          .sidebar { position: fixed; left: 0; top: 0; height: 100vh; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
          .sidebar.collapsed { margin-left: calc(-1 * var(--sidebar-width)); }
          .main-wrapper { width: 100vw; }
          .top-bar { position: sticky; top: 0; z-index: 1500; }
          .content-section { padding: 14px; }
          .card { padding: 14px; border-radius: 14px; }
          .query-row { grid-template-columns: 1fr; gap: 12px; }
          select, input { height: 52px; font-size: 17px; border-radius: 10px; }
          table { min-width: 520px; }
          th { padding: 12px 8px; font-size: 12px; }
          td { padding: 16px 8px; font-size: 20px; }
          .val-mid { font-size: 22px; }
          .val-range { font-size: 12px; }
          
          /* Tab3 è‰²å¡Šï¼šåœ¨æ‰‹æ©Ÿä¸è¦å¤ªä½”ä½ */
          .fine-box { flex-direction: column; align-items: stretch; gap: 10px; }
          .fine-select { width: 100% !important; }
          .color-badge { width: 100%; min-width: unset; font-size: 18px; padding: 10px 14px; }
        }

        @media (max-width: 480px) {
          .sidebar-header { font-size: 1.2rem; padding: 18px 16px; }
          .menu-item { padding: 13px 16px; font-size: 14px; }
          td { font-size: 18px; }
          .val-mid { font-size: 20px; }
        }

        /* ===== Mobile Picker ===== */
        .mobile-only { display: none; }
        .picker-btn { width: 100%; height: 52px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-size: 17px; text-align: left; padding: 0 12px; cursor: pointer; box-sizing: border-box; position: relative; }
        .picker-btn::after { content: "â–¾"; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #64748b; font-size: 16px; }
        .picker-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: flex-end; justify-content: center; z-index: 5000; }
        .picker-modal.hidden { display: none; }
        .picker-sheet { width: 100%; max-width: 640px; background: #fff; border-radius: 16px 16px 0 0; max-height: 78vh; overflow: hidden; box-shadow: 0 -10px 30px rgba(0,0,0,0.25); }
        .picker-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 14px; border-bottom: 1px solid #edf2f7; }
        .picker-title { font-weight: 800; color: #1a202c; }
        .picker-close { border: none; background: #f1f5f9; color: #334155; padding: 10px 12px; border-radius: 10px; font-weight: 700; cursor: pointer; }
        .picker-list { overflow-y: auto; -webkit-overflow-scrolling: touch; max-height: calc(78vh - 58px); }
        .picker-item { padding: 16px 14px; border-bottom: 1px solid #f1f5f9; font-size: 16px; color: #1f2937; cursor: pointer; }
        .picker-item.active { background: #ebf8ff; color: #1d4ed8; font-weight: 800; }
        select, input, textarea, button { -webkit-tap-highlight-color: transparent; }
        select:focus, input:focus, textarea:focus, button:focus { outline: none; box-shadow: none; }
        
        @media (max-width: 900px) {
          /* ä¿®æ­£é»ï¼šå¼·åˆ¶éš±è—åŸç”Ÿ selectï¼Œé¿å…é‡è¤‡å‡ºç¾ */
          #tab-life select { display: none !important; }
          #tab-life .mobile-only { display: block !important; }
        }

        /* ===== Admin UI (Global) ===== */
        .admin-bar { display:none; gap:10px; align-items:center; padding:10px 12px; margin-left:auto; }
        .admin-badge { font-size:12px; font-weight:800; color:#0f172a; background:#fde68a; padding:6px 10px; border-radius:999px; border:1px solid #f59e0b; }
        .admin-date { display:flex; align-items:center; gap:8px; }
        .admin-date label { margin:0; font-size:12px; color:#334155; }
        .admin-date input[type="date"]{ height:38px; font-size:14px; padding:0 10px; border-radius:10px; }
        .btn { border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; font-size: 14px; transition: 0.2s; white-space: nowrap; }
        .btn-primary{ background:#2563eb; color:#fff; }
        .btn-success{ background:#10b981; color:#fff; }
        .btn-ghost{ background:#f1f5f9; color:#0f172a; }
        .btn-danger{ background:#fee2e2; color:#ef4444; }
        .btn-danger:hover { background: #ef4444; color: white; }
        .btn:active{ transform: translateY(1px); }

        .admin-panel { display: none; background: #fafafa; border-top: 2px dashed #e2e8f0; padding: 15px; margin-top: 20px; border-radius: 0 0 12px 12px; }
        .admin-panel.active { display: block; animation: fadeIn 0.3s; }
        .admin-hint { font-size: 12px; color: #64748b; margin-bottom: 10px; line-height: 1.5; }
        
        .admin-table-wrap { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white; max-height: 400px; }
        .admin-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .admin-table th { background: #f1f5f9; color: #475569; font-size: 12px; padding: 8px; font-weight: bold; border-bottom: 1px solid #cbd5e1; white-space: nowrap; position: sticky; top: 0; z-index: 10;}
        .admin-table td { padding: 6px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #334155; vertical-align: middle; white-space: nowrap; }
        
        .admin-input { width: 100%; height: 32px; border: 1px solid #cbd5e1; border-radius: 6px; padding: 0 8px; font-size: 13px; background: #fff; box-sizing: border-box; }
        .admin-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .admin-actions-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }

        /* Drag Handle Styles */
        .drag-handle { cursor: move; color: #94a3b8; font-size: 18px; width: 30px; text-align: center; user-select: none; }
        .drag-handle:hover { color: #475569; }
        .admin-table tr.dragging { opacity: 0.5; background: #e2e8f0; }

        @media (max-width: 900px){
          .admin-bar{ flex-wrap:wrap; justify-content:flex-end; }
          .admin-date{ width:100%; justify-content:flex-end; }
        }

        /* Modals */
        .admin-modal-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:5000; align-items:center; justify-content:center; padding:16px; }
        .admin-modal{ width:min(860px, 100%); max-height: 88vh; overflow:auto; background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); display: flex; flex-direction: column;}
        .admin-modal header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; position: sticky; top: 0; z-index: 10; border-radius: 16px 16px 0 0; }
        .admin-modal .body{ padding:16px; flex: 1; overflow-y: auto; }
        .admin-field textarea{ width:100%; min-height: 220px; border:1px solid #cbd5e1; border-radius:12px; padding:10px; font-family: monospace; }
        .admin-actions { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fff; position: sticky; bottom: 0; z-index: 10; border-radius: 0 0 16px 16px; }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            RT åƒæ•¸å°ç…§æŸ¥è©¢
            <div class="version-tag">ç‰ˆæœ¬æ—¥æœŸ: 20241121</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchTab('tab-query')">ğŸ” åƒæ•¸ä¸­å€¼æŸ¥è©¢</div>
            <div class="menu-item" onclick="switchTab('tab-stack')">ğŸ“Š ç–Šæ¿ç‰‡æ•¸å°ç…§è¡¨</div>
            <div class="menu-item" onclick="switchTab('tab-fine')">ğŸ”§ ç²—æ²–å¾Œç´°åˆ‡-æ¿å…§æ§½</div>
            <div class="menu-item" onclick="switchTab('tab-feed')">ğŸš€ é‘½å­”é€²åˆ€é€Ÿå°ç…§è¡¨</div>
            <div class="menu-item" onclick="switchTab('tab-life')">â³ åˆ‡åˆ€å£½å‘½è¦å®š</div>
            <div class="menu-item" onclick="switchTab('tab-note')">ğŸ“ å‚™è¨»äº‹é …</div>
        </div>
        <div class="admin-section">
            <button style="background:#34495e; color:white; width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;" id="btnAdmin" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†æ¨¡å¼</button>
            <button style="background:#e74c3c; color:white; width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:none;" id="btnExit" onclick="toggleAdmin()">ğŸšª é€€å‡ºç®¡ç†</button>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="top-bar">
            <span class="hamburger-btn" style="cursor:pointer; font-size:24px; margin-right:15px; color:#2c3e50;" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">â˜°</span>
            <h3 id="currentTitle" style="margin:0; color:#2c3e50;">åƒæ•¸ä¸­å€¼æŸ¥è©¢</h3>
            <div class="admin-bar" id="adminBar">
                <span class="admin-badge">ç®¡ç†æ¨¡å¼</span>
                <div class="admin-date">
                    <label for="verDate">æ›´æ–°ç‰ˆæœ¬æ—¥æœŸ</label>
                    <input id="verDate" type="date" />
                </div>
                <button class="btn btn-ghost" onclick="openAdvancedEditor()">JSON ç·¨è¼¯</button>
                <button class="btn btn-primary" onclick="saveAllChanges()">æš«å­˜(æœ¬æ©Ÿ)</button>
                <button class="btn btn-success" onclick="downloadUpdatedHtml()">ğŸ“¥ åŒ¯å‡º HTML (æ°¸ä¹…ä¿å­˜)</button>
            </div>
        </div>

        <section id="tab-query" class="content-section active">
            <div class="card">
                <div class="query-row">
                    <div class="input-box"><label>é¡å‹</label><select id="typeSelect" onchange="updateSizeList();"></select></div>
                    <div class="input-box"><label>å°ºå¯¸</label><select id="sizeSelect" onchange="runQuery()"></select></div>
                </div>
                <div class="table-wrap">
                    <table id="mainTable">
                        <thead><tr><th>è½‰é€Ÿ (S)</th><th>é€²åˆ€ (F)</th><th>å£½å‘½ (N)</th><th>è£œå„Ÿ (D)</th><th>æª¯é¢é€Ÿåº¦ (F0X)</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div id="adminPanel-query" class="admin-panel">
                    <div class="admin-hint">
                        - æ‹–æ›³ã€Œâ˜°ã€å¯èª¿æ•´å°ºå¯¸é †åºã€‚<br>
                        - ç›´æ¥ç·¨è¼¯ã€Œå°ºå¯¸ Keyã€å¯é‡æ–°å‘½åå°ºå¯¸ã€‚
                    </div>
                    <div class="admin-actions-row">
                        <button class="btn btn-primary" onclick="adminParamAddSize()">ï¼‹ æ–°å¢å°ºå¯¸</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:40px;"></th><th>å°ºå¯¸ Key (å¯æ”¹å)</th><th>è½‰é€Ÿ (S)</th><th>é€²åˆ€ (F)</th><th>å£½å‘½ (N)</th><th>è£œå„Ÿ (D)</th><th>F0X</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-query"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-stack" class="content-section">
            <div class="card">
                <div class="query-row">
                    <div class="input-box"><label>æœ€å°åˆ‡åˆ€ç›´å¾‘ mil (mm)</label><select id="stkSizeSel" onchange="updateStackThickList(); runStackQuery()"></select></div>
                    <div class="input-box"><label>æˆå“æ¿åš</label><select id="stkThickSel" onchange="runStackQuery()"></select></div>
                </div>
                <div id="adminPanel-stack" class="admin-panel">
                    <div class="admin-hint">å¯ç·¨è¼¯èˆ‡æ‹–æ›³æ’åºè¦å‰‡ã€‚</div>
                    <div class="admin-actions-row">
                        <button class="btn btn-primary" onclick="adminStackAdd()">ï¼‹ æ–°å¢å°ºå¯¸è¦å‰‡</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:40px;"></th><th>å°ºå¯¸ Key (å¯æ”¹å)</th><th>æœ€å¤§åšåº¦æ–‡å­—</th><th>è¦å‰‡å­—ä¸² (ç¯„åœ:ç‰‡æ•¸)</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-stack"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div style="background:#f8fafc; padding:25px; border-radius:12px; text-align:center; border:1px solid #edf2f7;"><span style="font-size:13px; color:#64748b; display:block; margin-bottom:10px; font-weight:bold;">å»ºè­°ç–Šæ¿ç‰‡æ•¸</span><span id="stkResCount" style="font-size:36px; font-weight:800; color:#2b6cb0;">--</span></div>
                <div style="background:#f8fafc; padding:25px; border-radius:12px; text-align:center; border:1px solid #edf2f7;"><span style="font-size:13px; color:#64748b; display:block; margin-bottom:10px; font-weight:bold;">æœ€å¤§ç–Šæ¿åšåº¦ mil (mm)</span><span id="stkResMax" style="font-size:22px; font-weight:800; color:#1a202c;">--</span></div>
            </div>
        </section>

        <section id="tab-fine" class="content-section">
            <div class="card">
                <div class="input-box" style="margin-bottom:20px;"><label>å°ºå¯¸ mil (mm)</label>
                    <div class="fine-box"><select id="fineSizeSel" class="fine-select" onchange="runFineQuery()"></select><div id="fineBadge" class="color-badge">--</div></div>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>è½‰é€Ÿ (S)<br><small>ä¸­å€¼ (ç¯„åœ)</small></th><th>é€²åˆ€é€Ÿ (F)<br><small>ä¸­å€¼ (ç¯„åœ)</small></th><th>æª¯é¢é€Ÿåº¦ (F)<br><small>ä¸­å€¼ (ç¯„åœ)</small></th><th>è£œå„Ÿå€¼ (D)<br><small>å¯èª¿æ•´ç¯„åœ</small></th></tr></thead>
                        <tbody id="fineTableBody"></tbody>
                    </table>
                </div>

                <div id="adminPanel-fine" class="admin-panel">
                    <div class="admin-hint">å¯æ‹–æ›³æ’åºã€‚é¡è‰²è«‹å¡«å¯«ä¸­æ–‡åç¨±ï¼ˆå¦‚ï¼šåœŸé»ƒè‰²ï¼‰ã€‚</div>
                    <div class="admin-actions-row">
                        <button class="btn btn-primary" onclick="adminFineAdd()">ï¼‹ æ–°å¢ç´°åˆ‡è¦å‰‡</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:40px;"></th><th>æ¨™ç±¤åç¨±</th><th>é¡è‰²</th><th>è½‰é€Ÿ(ä¸­/ç¯„)</th><th>é€²åˆ€(ä¸­/ç¯„)</th><th>æª¯é¢(ä¸­/ç¯„)</th><th>è£œå„Ÿ(ä¸­/ç¯„)</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-fine"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-feed" class="content-section">
            <div class="card">
                <div class="input-box" style="margin-bottom:20px;"><label>é‘½é ­ç›´å¾‘ inch (mm)</label><select id="feedSizeSel" style="width:300px;" onchange="runFeedQuery()"></select></div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>è½‰é€Ÿ (S)<br><small>åƒè€ƒå€¼ (ç¯„åœ)</small></th><th style="background:#ebf8ff; color:#2b6cb0;">å°å¼•å­” (F)<br><small>åƒè€ƒå€¼ (ç¯„åœ)</small></th><th style="background:#f0fff4; color:#2f855a;">äºŒæ¬¡å­” (F)<br><small>åƒè€ƒå€¼ (ç¯„åœ)</small></th><th>å£½å‘½ (N)</th></tr>
                        </thead>
                        <tbody id="feedTableBody"></tbody>
                    </table>
                </div>

                 <div id="adminPanel-feed" class="admin-panel">
                    <div class="admin-hint">ç·¨è¼¯é‘½å­”é€²åˆ€é€Ÿè¦å‰‡ï¼Œå¯æ‹–æ›³æ’åºã€‚</div>
                    <div class="admin-actions-row">
                        <button class="btn btn-primary" onclick="adminFeedAdd()">ï¼‹ æ–°å¢é€²åˆ€è¦å‰‡</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:40px;"></th><th>ç›´å¾‘ç¯„åœæ¨™ç±¤</th><th>è½‰é€Ÿ(åƒ/ç¯„)</th><th>å°å¼•å­”(åƒ/ç¯„)</th><th>äºŒæ¬¡å­”(åƒ/ç¯„)</th><th>å£½å‘½</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-feed"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-life" class="content-section">
            <div class="card">
                <div class="query-row">
                    <div class="input-box">
                        <label>1. é¸æ“‡ç›´å¾‘ inch (mm)</label>
                        <select id="lifeSizeSel" onchange="updateLifeTypeList()"></select>
                        <button type="button" class="picker-btn mobile-only" id="lifeSizeBtn" onclick="openPicker('lifeSizeSel','é¸æ“‡ç›´å¾‘')"></button>
                    </div>
                    <div class="input-box">
                        <label>2. é¸æ“‡å‹æ…‹</label>
                        <select id="lifeTypeSel" onchange="runLifeQuery()"></select>
                        <button type="button" class="picker-btn mobile-only" id="lifeTypeBtn" onclick="openPicker('lifeTypeSel','é¸æ“‡å‹æ…‹')"></button>
                    </div>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th style="width:50%;">æ™®é€šæè³ª</th><th style="background:#fff7ed; color:#c2410c; border-bottom: 2px solid #fdba74;">å…¶ä»–æè³ª</th></tr>
                        </thead>
                        <tbody id="lifeTableBody"></tbody>
                    </table>
                </div>

                <div id="adminPanel-life" class="admin-panel">
                    <div class="admin-hint">é»æ“Šã€Œâ‡… èª¿æ•´ç›´å¾‘é †åºã€å¯ç›´è§€èª¿æ•´ä¸‹æ‹‰é¸å–®çš„é †åºã€‚</div>
                    <div class="admin-actions-row">
                        <button type="button" class="btn btn-primary" onclick="adminLifeAddSize()">ï¼‹ æ–°å¢ç›´å¾‘</button>
                        <button type="button" class="btn btn-danger" onclick="adminLifeDeleteSize()">åˆªé™¤ç›®å‰ç›´å¾‘</button>
                        <button type="button" class="btn btn-ghost" onclick="adminLifeOpenReorder()">â‡… èª¿æ•´ç›´å¾‘é †åº</button>
                        <button type="button" class="btn btn-ghost" onclick="adminLifeAddType()">ï¼‹ æ–°å¢å‹æ…‹</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:20px;"></th><th>å‹æ…‹</th><th>æ™®é€š-ä¸­å€¼</th><th>æ™®é€š-ç¯„åœ</th><th>å…¶ä»–æè³ª-ä¸­å€¼</th><th>å…¶ä»–æè³ª-ç¯„åœ</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-life"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-note" class="content-section">
            <div class="card">
                <ul class="note-list"></ul> <div id="adminPanel-note" class="admin-panel">
                    <div class="admin-hint">å‚™è¨»äº‹é …ç®¡ç†ï¼Œå¯æ‹–æ›³æ’åºã€‚</div>
                    <div class="admin-actions-row">
                        <button class="btn btn-primary" onclick="adminNoteAdd()">ï¼‹ æ–°å¢ä¸€è¡Œ</button>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table">
                            <thead><tr><th style="width:40px;"></th><th style="width:50px;">åºè™Ÿ</th><th>å…§å®¹</th><th style="width:60px;">æ“ä½œ</th></tr></thead>
                            <tbody id="adminBody-note"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <div id="pickerModal" class="picker-modal hidden" role="dialog"><div class="picker-sheet"><div class="picker-header"><div id="pickerTitle" class="picker-title">é¸æ“‡</div><button type="button" class="picker-close" onclick="closePicker()">é—œé–‰</button></div><div id="pickerList" class="picker-list"></div></div></div>
    
    <div class="admin-modal-backdrop" id="adminModalBackdrop" role="dialog"><div class="admin-modal"><header><h4 style="margin:0;font-size:16px;">é€²éšç·¨è¼¯ï¼ˆJSONï¼‰</h4><button class="btn btn-ghost" onclick="closeAdminModal()">é—œé–‰</button></header><div class="body"><div class="admin-hint">å¯åœ¨æ­¤å‚™ä»½æˆ–é‚„åŸæ‰€æœ‰è¨­å®šã€‚</div><div class="admin-field"><textarea id="adminJson" spellcheck="false"></textarea></div></div><div class="admin-actions"><button class="btn btn-primary" onclick="applyJsonChanges()">å¥—ç”¨</button></div></div></div>

    <div class="admin-modal-backdrop" id="reorderModal" role="dialog" style="z-index: 5001;">
        <div class="admin-modal" style="width: 450px; max-width: 90%; max-height: 80vh;">
            <header>
                <h4 style="margin:0;font-size:16px;">èª¿æ•´ç›´å¾‘é †åº</h4>
                <button class="btn btn-ghost" onclick="document.getElementById('reorderModal').style.display='none'">å–æ¶ˆ</button>
            </header>
            <div class="body">
                <div class="admin-hint">æ‹–æ›³ã€Œâ˜°ã€å³å¯èª¿æ•´é †åºï¼Œå®Œæˆå¾Œè«‹æŒ‰ã€Œä¿å­˜é †åºã€ã€‚</div>
                <div class="admin-table-wrap" style="max-height: 50vh; overflow-y: auto;">
                    <table class="admin-table">
                        <tbody id="reorderTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="admin-actions">
                <button class="btn btn-primary" onclick="adminLifeSaveOrder()">ä¿å­˜é †åº</button>
            </div>
        </div>
    </div>

<script>
    const colorMap = { "åœŸé»ƒè‰²":"#D4A017", "è˜‹æœç¶ ":"#8DB600", "é†¬ç´…è‰²":"#800000", "é»‘è‰²":"#000000", "æ·±è—è‰²":"#00008B", "å’–å•¡è‰²":"#6F4E37", "é’è‰²":"#00CED1", "æŸ‘ç´…è‰²":"#FF4500", "æ·¡ç´«è‰²":"#E6E6FA", "å¢¨ç¶ è‰²":"#006400", "ç²‰ç´…è‰²":"#FF69B4", "ç™½è‰²":"#C0C0C0", "æ£•ç´…è‰²":"#A52A2A", "æ·¡æ¢¨è‰²":"#F0EAD6", "æ·±ç´«è‰²":"#800080", "æ·¡æ©˜è‰²":"#FFB84D", "å¡å…¶è‰²":"#F0E68C", "æ·¡è—è‰²":"#ADD8E6", "ç°è‰²":"#808080", "å‡é»ƒè‰²":"#F0E68C", "èƒ­è„‚ç´…":"#C71585", "å¤©è—è‰²":"#87CEEB", "æ¡ƒç´…è‰²":"#FF69B4", "å¤§ç´…è‰²":"#FF0000", "æ¾æ¨¹ç¶ ":"#01796F" };

    // --- Data Source ---
    let toolData = {
        "0.0197": { FF:["40","10","50","0.0098","10"], AA:["40","10","50","0.0098","10"], RD:["40","10","50","0.0098","8"], G42:["40","7","30","0.0098","8"], OR:["40","10","50","0.0103","10"] },
        "0.0197 CB": { FF:["40","10","150","0.0098","10"], AA:["40","10","150","0.0098","10"], RD:["40","10","150","0.0098","8"], G42:["40","7","75","0.0098","8"], OR:["40","10","150","0.0103","10"] },
        "0.0236": { FF:["40","10","50","0.0118","10"], AA:["40","10","50","0.0118","10"], RD:["40","10","50","0.0118","8"], G42:["40","7","30","0.0118","8"], OR:["40","10","50","0.0123","10"] },
        "0.0236 CB": { FF:["40","10","150","0.0118","10"], AA:["40","10","150","0.0118","10"], RD:["40","10","150","0.0118","8"], G42:["40","7","75","0.0118","8"], OR:["40","10","150","0.0123","10"] },
        "0.031": { FF:["33","12","100","0.0155","12"], AA:["30","20","300","0.0155","30"], RD:["30","10","90","0.0155","10"], G42:["33","10","50","0.0155","10"], OR:["30","12","90","0.0160","10"], RDL:["-30","10","90","0.0155","10"] },
        "0.035": { FF:["33","12","100","0.0175","12"], AA:["30","20","300","0.0175","30"], RD:["30","10","90","0.0175","10"], G42:["33","10","50","0.0175","10"], OR:["30","12","90","0.0180","10"] },
        "0.039": { FF:["33","12","200","0.0195","12"], AA:["30","20","300","0.0195","30"], RD:["30","10","200","0.0195","10"], G42:["32","10","50","0.0195","10"], OR:["30","12","200","0.0200","10"], RDL:["-30","10","160","0.0195","10"] },
        "0.039 CB": { FF:["33","12","700","0.0195","12"], AA:["30","20","700","0.0195","30"], RD:["30","10","700","0.0195","10"], G42:["32","10","150","0.0195","10"], OR:["30","12","700","0.0200","10"] },
        "0.039 LCB": { FF:["33","12","300","0.0195","12"], AA:["30","20","300","0.0195","30"], RD:["30","10","300","0.0195","10"], G42:["32","10","300","0.0195","10"], OR:["30","12","300","0.0200","10"] },
        "0.047": { FF:["32","12","200","0.0235","12"], AA:["30","30","370","0.0235","30"], RD:["30","10","200","0.0235","10"], G42:["32","10","80","0.0235","10"], OR:["30","15","200","0.0240","10"] },
        "0.047 CB": { FF:["32","12","300","0.0235","12"], AA:["30","30","300","0.0235","30"], RD:["30","10","300","0.0235","10"], G42:["32","10","300","0.0235","10"], OR:["30","15","300","0.0240","10"] },
        "0.055": { FF:["32","15","420","0.0275","50"], AA:["30","35","420","0.0275","50"], RD:["30","10","200","0.0275","10"], G42:["30","10","80","0.0275","10"], OR:["30","15","200","0.0280","10"] },
        "0.059": { FF:["32","20","420","0.0295","50"], AA:["30","35","420","0.0295","50"], RD:["28","10","250","0.0295","10"], G42:["30","10","80","0.0295","10"], OR:["30","20","250","0.0302","10"] },
        "0.062": { FF:["32","30","520","0.0315","50"], AA:["28","40","520","0.0315","50"], RD:["23","5","350","0.0315","10"], G42:["28","5","100","0.0315","10"], OR:["28","30","350","0.0322","10"] },
        "0.079": { FF:["32","30","700","0.0395","50"], AA:["28","40","700","0.0395","50"], RD:["22","5","400","0.0395","10"], G42:["28","5","100","0.0395","10"], OR:["28","30","400","0.0405","10"] },
        "0.093": { FF:["32","30","1020","0.0465","50"], AA:["28","40","1020","0.0465","50"], RD:["22","5","400","0.0465","10"], G42:["25","5","100","0.0465","10"], OR:["28","30","800","0.0485","10"] },
        "å°æ–¼0.1260(ä¸å«)": { DA:["30","10","1500","--","10"], DAFF:["30","30","1500","--","10"] },
        "å¤§æ–¼0.1260(å«)": { DA:["20","10","1500","--","10"], DAFF:["20","10","1500","--","10"] }
    };

    let stackingRules = {
        "15.7 (0.40)": { max: "40 (1.02)", options: {"9~10":4, "11~13":3, "14~20":2, "21~40":1} },
        "19.7 (0.50)": { max: "66 (1.68)", options: {"10~16":4, "17~22":3, "23~33":2, "34~66":1} },
        "19.7 LCBRD (0.50)": { max: "86 (2.18)", options: {"10~17":5, "18~21":4, "22~28":3, "29~43":2, "44~86":1} },
        "23.6 (0.60)": { max: "88 (2.24)", options: {"15~22":4, "23~29":3, "30~44":2, "45~88":1} },
        "23.6 LCBRD (0.60)": { max: "108 (2.74)", options: {"15~21":5, "22~27":4, "28~36":3, "37~54":2, "55~108":1} },
        "31~35 (0.80-0.90)": { max: "122 (2.74)", options: {"9~12":10, "13":9, "14~15":8, "16~17":7, "18~20":6, "21~24":5, "25~30":4, "31~40":3, "41~61":2, "62~122":1} },
        "35 LRD (0.90)": { max: "170 (4.32)", options: {"15~21":8, "22~24":7, "25~28":6, "29~34":5, "35~42":4, "43~56":3, "57~85":2} },
        "39~55 (0.10-1.40)": { max: "205 (5.21)", options: {"15~22":8, "23~25":7, "26~30":6, "31~37":5, "38~47":4, "48~64":3, "65~99":2} },
        "59~98 (1.50-2.50)": { max: "259 (6.6)", options: {"15~18":12, "19~22":10, "23~28":8, "29~33":7, "34~39":6, "40~47":5, "48~60":4, "61~81":3} },
        "39~47 LCBRD (1.00-1.20)": { max: "263 (6.7)", options: {"15~18":12, "19~22":10, "23~28":8, "29~33":7, "34~39":6, "40~47":5, "48~60":4, "61~68":3} }
    };

    let fineCutData = [
        { label: "0.0197\" (åœŸé»ƒè‰²)", s:["40","30~45"], f:["8","5~10"], t:["8","5~10"], d:["0.0098","+/-0.003\""], color:"åœŸé»ƒè‰²" },
        { label: "0.0197\" LCBRD (è˜‹æœç¶ )", s:["45","40~55"], f:["8","5~10"], t:["8","5~10"], d:["0.0098","+/-0.003\""], color:"è˜‹æœç¶ " },
        { label: "0.0236\" (é†¬ç´…è‰²)", s:["40","30~45"], f:["8","5~10"], t:["8","5~10"], d:["0.0118","+/-0.003\""], color:"é†¬ç´…è‰²" },
        { label: "0.0236\" LCBRD (é»‘è‰²)", s:["40","30~50"], f:["8","5~10"], t:["8","5~10"], d:["0.0118","+/-0.003\""], color:"é»‘è‰²" },
        { label: "0.031\" (æ·±è—è‰²)", s:["30","25~40"], f:["15","10~20"], t:["10","10~20"], d:["0.0155","+/-0.003\""], color:"æ·±è—è‰²" },
        { label: "0.031\" CBRD (å’–å•¡è‰²)", s:["55","40~55"], f:["15","10~20"], t:["10","10~20"], d:["0.0155","+/-0.003\""], color:"å’–å•¡è‰²" },
        { label: "0.031\" (é€†)æ¼¢å° (é’è‰²)", s:["-30","-30"], f:["10","5~10"], t:["10","10~20"], d:["0.0155","+/-0.003\""], color:"é’è‰²" },
        { label: "0.035\" (æŸ‘ç´…è‰²)", s:["30","20~40"], f:["15","10~20"], t:["10","10~20"], d:["0.0175","+/-0.003\""], color:"æŸ‘ç´…è‰²" },
        { label: "0.035\" LRD (æ·¡ç´«è‰²)", s:["30","20~40"], f:["15","10~20"], t:["10","10~20"], d:["0.0175","+/-0.003\""], color:"æ·¡ç´«è‰²" },
        { label: "0.039\" (å¢¨ç¶ è‰²)", s:["30","25~40"], f:["15","10~20"], t:["10","10~20"], d:["0.0195","+/-0.003\""], color:"å¢¨ç¶ è‰²" },
        { label: "0.039\" CBRD (ç²‰ç´…è‰²)", s:["35","25~50"], f:["15","10~20"], t:["10","10~20"], d:["0.0195","+/-0.003\""], color:"ç²‰ç´…è‰²" },
        { label: "0.039\" (é€†)å°–é» (ç™½è‰²)", s:["-30","-25~-40"], f:["10","10~20"], t:["10","10~20"], d:["0.0195","+/-0.003\""], color:"ç™½è‰²" },
        { label: "0.0039\" LCBRD (æ£•ç´…è‰²)", s:["35","25~50"], f:["15","10~20"], t:["10","10~20"], d:["0.0195","+/-0.003\""], color:"æ£•ç´…è‰²" },
        { label: "0.043\" (æ·¡æ¢¨è‰²)", s:["30","25~40"], f:["15","10~20"], t:["10","10~20"], d:["0.0215","+/-0.003\""], color:"æ·¡æ¢¨è‰²" },
        { label: "0.047\" (æ·±ç´«è‰²)", s:["30","20~40"], f:["28","10~30"], t:["20","10~25"], d:["0.0235","+/-0.003\""], color:"æ·±ç´«è‰²" },
        { label: "0.062\" (å‡é»ƒè‰²)", s:["30","18~35"], f:["35","10~40"], t:["25","10~30"], d:["0.0315","+/-0.003\""], color:"å‡é»ƒè‰²" },
        { label: "0.098\" (æ¾æ¨¹ç¶ )", s:["28","18~30"], f:["35","10~40"], t:["40","10~45"], d:["0.0490","+/-0.003\""], color:"æ¾æ¨¹ç¶ " }
    ];

    let feedData = [ { label: "0.0279\" ä»¥ä¸‹", s:["30","20~40"], pF:["20","10~20"], sF:["10","10~20"], life: "1500" }, { label: "0.0280\"~0.0429\"", s:["30","20~40"], pF:["30","10~30"], sF:["10","10~20"], life: "1500" }, { label: "0.0430\"~0.0865\"", s:["30","20~40"], pF:["40","10~40"], sF:["10","10~20"], life: "1500" }, { label: "0.0866\"~0.1014\"", s:["25","20~35"], pF:["50","10~50"], sF:["10","10~20"], life: "1500" }, { label: "0.1015\"~0.1259\"", s:["25","20~35"], pF:["40","10~40"], sF:["10","10~20"], life: "1500" }, { label: "0.1260\"~0.1456\"", s:["20","15~25"], pF:["20","10~20"], sF:["10","10~20"], life: "1500" }, { label: "0.1457\" ä»¥ä¸Š", s:["20","15~25"], pF:["10","10~15"], sF:["10","10~20"], life: "1500" } ];

    let toolLifeRules = {
        "0.0197\" (0.500mm)": { "éè†œåˆ€": [["150","100~150"],["150","100~150"]], "ä¸€èˆ¬åˆ€": [["50","10~50"],["30","10~50"]] },
        "0.0236\" (0.600mm)": { "éè†œåˆ€": [["150","100~150"],["150","100~150"]], "ä¸€èˆ¬åˆ€": [["50","10~50"],["30","10~50"]] },
        "0.031\" (0.800mm)": { "éè†œåˆ€": [["450","300~450"],["300","250~300"]], "ä¸€èˆ¬åˆ€": [["300","260~300"],["100","60~100"]] },
        "0.031\" é€†è½‰åˆ€ (0.800mm)": { "ä¸€èˆ¬åˆ€": [["90","90"],["90","90"]] },
        "0.035\" (0.900mm)": { "ä¸€èˆ¬åˆ€": [["300","260~300"],["100","60~100"]], "é•·åˆƒåˆ€": [["300","260~300"],["100","60~100"]] },
        "0.039\" (1.000mm)": { "éè†œåˆ€": [["1000","700~1000"],["700","600~700"]], "ä¸€èˆ¬åˆ€": [["300","260~300"],["200","120~200"]] },
        "0.039\" é€†è½‰åˆ€ (1.000mm)": { "ä¸€èˆ¬åˆ€": [["160","160"],["160","160"]] },
        "0.043\" (1.100mm)": { "ä¸€èˆ¬åˆ€": [["300","260~300"],["100","60~100"]] },
        "0.047\" (1.200mm)": { "éè†œåˆ€": [["1000","700~1000"],["700","600~700"]], "ä¸€èˆ¬åˆ€": [["370","330~370"],["200","120~200"]] },
        "0.051\"~0.059\" (1.300-1.500mm)": { "ä¸€èˆ¬åˆ€": [["370~420","330~420"],["140~250","100~250"]] },
        "0.062\"~0.075\" (1.600-1.900mm)": { "ä¸€èˆ¬åˆ€": [["520","480~520"],["320~400","280~400"]] },
        "0.079\" (å…§æ§½)": { "ä¸€èˆ¬åˆ€": [["700","580~700"],["620","400~620"]] },
        "0.079\" (å¤–å‹)": { "ä¸€èˆ¬åˆ€": [["620","580~620"],["420","380~420"]] },
        "0.093\" (å…§æ§½)": { "ä¸€èˆ¬åˆ€": [["620","580~620"],["420","380~420"]] },
        "0.093\" (å¤–å‹)": { "ä¸€èˆ¬åˆ€": [["1020","980~1020"],["820","780~820"]] },
        "0.098\" (å…§æ§½)": { "ä¸€èˆ¬åˆ€": [["520","480~520"],["320","280~320"]] }
    };

    let notesData = [
        "HITGã€LKã€RFã€HFã€EM390åŠEM526æè³ªçš„å„åˆ‡åˆ€åŠå°å¼•å­”ä¸‹é‘½é€Ÿåº¦ 5~10 (ç²—åˆ‡ã€ç²—åˆ‡å°å¼•å­”åŠå¤–å‹é™¤å¤–)ã€‚",
        "åˆ‡å…§æ§½ç‚ºéŠ…é¢ï¼šåˆ‡åˆ€ 31~59 mil å£½å‘½ç”¨ 50 INCHï¼›62~93 mil å£½å‘½ç”¨ 100 INCHã€‚",
        "è—åœ–æ¨™ç¤º â—ã€â–³ã€åˆ‡è‘«è˜†å­”ã€é‡‘æ‰‹æŒ‡ã€äºŒæ¬¡å­”æˆ–ç¨‹å¼æœ‰èµ° G42ï¼Œåˆ‡åˆ€è¦æ ¼å£½å‘½è¦å®šè«‹ä¾åˆ—è¡¨å°ç…§ã€‚",
        "ç²—ã€è£åˆ‡åˆ‡åˆ€ 31~51 mil å£½å‘½è¦å®šï¼šæ™®é€šæè³ªè¨­å®šä¸Šé™ ~50 INCHï¼Œå°é¢é€Ÿåº¦ 10~30ã€‚",
        "ç²—ã€è£åˆ‡åˆ‡åˆ€ 55~93 mil å£½å‘½è¦å®šï¼šæ™®é€šæè³ªè¨­å®šä¸Šé™ ~180 INCHï¼Œå°é¢é€Ÿåº¦ 10~50 (M57è–„æ¿ç‚º20)ã€‚",
        "æ¸…ç²‰åˆ‡åˆ€ 31~51 mil å£½å‘½è¦å®šï¼šæ™®é€šæè³ªè¨­å®šä¸Šé™ï¼Œå°é¢é€Ÿåº¦ 30ã€‚",
        "æ¸…ç²‰åˆ‡åˆ€ 55~93 mil å£½å‘½è¦å®šï¼šæ™®é€šæè³ªè¨­å®šä¸Šé™ï¼Œå°é¢é€Ÿåº¦ 50 (M57è–„æ¿ç‚º20)ã€‚",
        "H30æ–™è™Ÿã€R01æ–™è™Ÿåˆ‡å…§æ§½åˆ‡åˆ€ï¼š62 mil å£½å‘½è¨­ 200 INCHï¼›79 mil å£½å‘½è¨­ 200 INCHã€‚",
        "C66æ–™è™Ÿå¤–å‹ 62 mil åˆ‡åˆ€å£½å‘½ä¸Šé™è¨­å®š 300 INCHã€‚",
        "39~47 mil è£é–‹åˆ€å¯æ”¹ä½¿ç”¨ç›²åˆ‡éçš„ 35 mil åˆ‡åˆ€ (éœ€æ”¹ç‚º 35 mil åƒæ•¸)ã€‚",
        "C81ã€C91æ–™è™Ÿ 39 milã€47 mil é•·åˆƒéè†œåˆ‡åˆ€å£½å‘½ä¸Šé™è¨­å®š 300 INCHã€‚"
    ];

    let isEditing = false;

    // --- Core Logic ---
    function setSelectOptions(selectEl, values, getLabel) {
        selectEl.innerHTML = "";
        values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = String(v);
            opt.textContent = getLabel ? getLabel(v) : String(v);
            selectEl.appendChild(opt);
        });
    }

    function switchTab(id) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
            document.getElementById('currentTitle').innerText = event.currentTarget.innerText;
        }
        if (window.matchMedia('(max-width: 900px)').matches) {
            document.getElementById('sidebar').classList.add('collapsed');
        }
        document.querySelector('.main-wrapper')?.scrollTo({ top: 0, behavior: 'smooth' });
        adminRefreshAll();
    }

    // --- Drag & Drop Generic Logic ---
    function makeSortable(tbodyId, onUpdate) {
        const tbody = document.getElementById(tbodyId);
        let dragSrcEl = null;

        tbody.addEventListener('dragstart', function(e) {
            dragSrcEl = e.target.closest('tr');
            if(!dragSrcEl) return;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', dragSrcEl.innerHTML);
            dragSrcEl.classList.add('dragging');
        });

        tbody.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        });

        tbody.addEventListener('dragenter', function(e) {
            e.preventDefault();
            const tr = e.target.closest('tr');
            if (tr && tr !== dragSrcEl) {
                // simple visual feedback could go here
            }
        });

        tbody.addEventListener('drop', function(e) {
            e.stopPropagation();
            const dropTarget = e.target.closest('tr');
            if (dragSrcEl && dropTarget && dragSrcEl !== dropTarget) {
                // Determine position
                const rect = dropTarget.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                tbody.insertBefore(dragSrcEl, next ? dropTarget.nextSibling : dropTarget);
                
                // Trigger Data Update
                if(onUpdate) onUpdate();
            }
            return false;
        });

        tbody.addEventListener('dragend', function(e) {
            if(dragSrcEl) dragSrcEl.classList.remove('dragging');
        });
    }

    // --- Tab 1 Logic ---
    function updateSizeList() {
        const t = document.getElementById('typeSelect').value;
        const valid = Object.keys(toolData).filter(s => toolData[s][t] !== undefined);
        const sel = document.getElementById('sizeSelect');
        const oldVal = sel.value;
        sel.innerHTML = valid.map(s => `<option value="${s}">${s}</option>`).join('');
        if(valid.includes(oldVal)) sel.value = oldVal;
        runQuery();
        adminRefreshAll();
    }
    function runQuery() {
        const s = document.getElementById('sizeSelect').value, t = document.getElementById('typeSelect').value;
        if (!s || !toolData[s] || !toolData[s][t]) {
             document.getElementById('tableBody').innerHTML = '';
             return;
        }
        const d = toolData[s][t];
        document.getElementById('tableBody').innerHTML = `<tr><td>${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td><td>${d[3]}</td><td>${d[4]??'-'}</td></tr>`;
    }

    // --- Tab 2 Logic ---
    function updateStackThickList() {
        const s = document.getElementById('stkSizeSel').value;
        if(!stackingRules[s]) return;
        const opts = stackingRules[s].options;
        const sel = document.getElementById('stkThickSel');
        sel.innerHTML = Object.keys(opts).map(t => `<option value="${t}">${t}</option>`).join('');
        runStackQuery();
    }
    function runStackQuery() {
        const s = document.getElementById('stkSizeSel').value, r = document.getElementById('stkThickSel').value;
        if(!stackingRules[s]) return;
        document.getElementById('stkResMax').innerText = stackingRules[s].max;
        document.getElementById('stkResCount').innerText = (stackingRules[s].options[r] || '--') + " ç‰‡";
    }

    // --- Tab 3 Logic ---
    function runFineQuery() {
        const i = document.getElementById('fineSizeSel').value, d = fineCutData[i], b = document.getElementById('fineBadge');
        if(!d) return;
        b.innerText = d.color; b.style.backgroundColor = colorMap[d.color] || '#eee';
        document.getElementById('fineTableBody').innerHTML = `<tr><td><span class="val-mid">${d.s[0]}</span><span class="val-range">${d.s[1]}</span></td><td><span class="val-mid">${d.f[0]}</span><span class="val-range">${d.f[1]}</span></td><td><span class="val-mid">${d.t[0]}</span><span class="val-range">${d.t[1]}</span></td><td><span class="val-mid">${d.d[0]}</span><span class="val-range">${d.d[1]}</span></td></tr>`;
    }

    // --- Tab 4 Logic ---
    function runFeedQuery() {
        const i = document.getElementById('feedSizeSel').value, d = feedData[i];
        if(!d) return;
        document.getElementById('feedTableBody').innerHTML = `<tr><td><span class="val-mid">${d.s[0]}</span><span class="val-range">${d.s[1]}</span></td><td style="background:#ebf8ff;"><span class="val-mid" style="color:#2b6cb0;">${d.pF[0]}</span><span class="val-range">${d.pF[1]}</span></td><td style="background:#f0fff4;"><span class="val-mid" style="color:#2f855a;">${d.sF[0]}</span><span class="val-range">${d.sF[1]}</span></td><td><span class="val-mid">${d.life}</span></td></tr>`;
    }

    // --- Tab 5 Logic ---
    function updateLifeTypeList() {
        const s = document.getElementById('lifeSizeSel').value;
        const tSel = document.getElementById('lifeTypeSel');
        const types = Object.keys(toolLifeRules[s] || {});
        setSelectOptions(tSel, types);
        runLifeQuery();
        syncPickerButtons();
        adminRefreshAll();
    }
    function runLifeQuery() {
        const s = document.getElementById('lifeSizeSel').value, t = document.getElementById('lifeTypeSel').value;
        if (!s || !t || !toolLifeRules[s] || !toolLifeRules[s][t]) {
             document.getElementById('lifeTableBody').innerHTML = '';
             return;
        }
        const d = toolLifeRules[s][t];
        syncPickerButtons();
        document.getElementById('lifeTableBody').innerHTML = `<tr>
            <td><span class="val-mid">${d[0][0]}</span><span class="val-range">${d[0][1]}</span></td>
            <td style="background:#fff7ed;"><span class="val-mid" style="color:#c2410c;">${d[1][0]}</span><span class="val-range">${d[1][1]}</span></td>
        </tr>`;
    }

    // --- Tab 6 Logic ---
    function renderNotes(){
        const ul = document.querySelector('.note-list');
        ul.innerHTML = '';
        (notesData || []).forEach((txt, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<b>${idx+1}.</b> ${txt}`;
            ul.appendChild(li);
        });
    }

    // --- Admin Global ---
    function toggleAdmin() {
        if(!isEditing) {
            if(prompt("å¯†ç¢¼:") !== "YPD14-RT") return;
            isEditing = true;
            document.getElementById('btnAdmin').style.display = 'none';
            document.getElementById('btnExit').style.display = 'block';
            showAdminBar(true);
        } else {
            isEditing = false;
            document.getElementById('btnAdmin').style.display = 'block';
            document.getElementById('btnExit').style.display = 'none';
            showAdminBar(false);
            closeAdminModal();
        }
        document.body.classList.toggle('editing', isEditing);
        adminRefreshAll();
        runQuery(); 
    }

    function showAdminBar(show){
        document.getElementById('adminBar').style.display = show ? 'flex' : 'none';
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.toggle('active', show));
    }

    function adminRefreshAll() {
        if(!isEditing) return;
        adminParamRefresh();
        adminStackRefresh();
        adminFineRefresh();
        adminFeedRefresh();
        adminLifeRefreshPanel();
        adminNoteRefresh();
    }

    // --- Admin: Tab 1 (Param) ---
    function adminParamRefresh(){
        const type = document.getElementById('typeSelect').value;
        const tbody = document.getElementById('adminBody-query');
        tbody.innerHTML = '';
        
        const sizes = Object.keys(toolData).filter(k => toolData[k][type]);
        
        sizes.forEach(size => {
            const arr = toolData[size][type];
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.key = size;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td><input class="admin-input" value="${size}" onchange="adminParamRename(this, '${size}')" style="font-weight:bold;"></td>
                <td><input class="admin-input" value="${arr[0]}" onchange="adminParamSet('${size}','${type}',0,this.value)"></td>
                <td><input class="admin-input" value="${arr[1]}" onchange="adminParamSet('${size}','${type}',1,this.value)"></td>
                <td><input class="admin-input" value="${arr[2]}" onchange="adminParamSet('${size}','${type}',2,this.value)"></td>
                <td><input class="admin-input" value="${arr[3]}" onchange="adminParamSet('${size}','${type}',3,this.value)"></td>
                <td><input class="admin-input" value="${arr[4]||''}" onchange="adminParamSet('${size}','${type}',4,this.value)"></td>
                <td><button class="btn btn-danger" onclick="adminParamDel('${size}','${type}')">åˆªé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-query', adminParamReorder);
    }
    
    function adminParamReorder() {
        const tbody = document.getElementById('adminBody-query');
        const rows = [...tbody.querySelectorAll('tr')];
        const newOrderKeys = rows.map(r => r.dataset.key);
        
        const newToolData = {};
        const oldKeys = Object.keys(toolData);
        
        newOrderKeys.forEach(k => {
            if(toolData[k]) newToolData[k] = toolData[k];
        });
        oldKeys.forEach(k => {
            if(!newToolData[k]) newToolData[k] = toolData[k];
        });
        
        toolData = newToolData;
        updateSizeList(); 
    }

    function adminParamRename(input, oldKey) {
        const newKey = input.value.trim();
        if(!newKey || newKey === oldKey) return;
        if(toolData[newKey]) { alert('æ­¤å°ºå¯¸åç¨±å·²å­˜åœ¨'); input.value = oldKey; return; }
        
        const newToolData = {};
        Object.keys(toolData).forEach(k => {
            if (k === oldKey) {
                newToolData[newKey] = toolData[oldKey];
            } else {
                newToolData[k] = toolData[k];
            }
        });
        toolData = newToolData;
        
        input.setAttribute('onchange', `adminParamRename(this, '${newKey}')`);
        const btn = input.closest('tr').querySelector('.btn-danger');
        const type = document.getElementById('typeSelect').value;
        btn.setAttribute('onclick', `adminParamDel('${newKey}','${type}')`);
        input.closest('tr').dataset.key = newKey;
        
        updateSizeList();
    }

    function adminParamSet(s,t,idx,val){ toolData[s][t][idx] = val; runQuery(); }
    function adminParamAddSize(){
        const s = prompt("è«‹è¼¸å…¥å°ºå¯¸ Key (ä¾‹å¦‚ 0.055):");
        if(!s) return;
        const t = document.getElementById('typeSelect').value;
        if(!toolData[s]) toolData[s] = {};
        if(toolData[s][t]) { alert('å·²å­˜åœ¨'); return; }
        toolData[s][t] = ["0","0","0","0","0"];
        updateSizeList();
    }
    function adminParamDel(s,t){
        if(!confirm(`ç¢ºå®šåˆªé™¤ ${s} çš„ ${t} æ•¸æ“šå—ï¼Ÿ`)) return;
        delete toolData[s][t];
        updateSizeList();
    }

    // --- Admin: Tab 2 (Stack) ---
    function adminStackRefresh(){
        const tbody = document.getElementById('adminBody-stack');
        tbody.innerHTML = '';
        Object.keys(stackingRules).forEach(key => {
            const rule = stackingRules[key];
            const optStr = Object.entries(rule.options).map(([k,v])=>`${k}:${v}`).join(', ');
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.key = key;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td><input class="admin-input" value="${key}" onchange="adminStackRename(this, '${key}')" style="font-weight:bold;"></td>
                <td><input class="admin-input" value="${rule.max}" onchange="adminStackSetMax('${key}',this.value)"></td>
                <td><input class="admin-input" value="${optStr}" onchange="adminStackSetOpt('${key}',this.value)"></td>
                <td><button class="btn btn-danger" onclick="adminStackDel('${key}')">åˆªé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-stack', adminStackReorder);
    }
    
    function adminStackReorder(){
        const tbody = document.getElementById('adminBody-stack');
        const rows = [...tbody.querySelectorAll('tr')];
        const newRules = {};
        rows.forEach(r => {
            const k = r.dataset.key;
            if(stackingRules[k]) newRules[k] = stackingRules[k];
        });
        stackingRules = newRules;
        document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function adminStackRename(input, oldKey){
        const newKey = input.value.trim();
        if(!newKey || newKey === oldKey) return;
        if(stackingRules[newKey]) { alert('åç¨±å·²å­˜åœ¨'); input.value = oldKey; return; }
        
        const newRules = {};
        Object.keys(stackingRules).forEach(k => {
            if(k === oldKey) newRules[newKey] = stackingRules[oldKey];
            else newRules[k] = stackingRules[k];
        });
        stackingRules = newRules;
        
        input.setAttribute('onchange', `adminStackRename(this, '${newKey}')`);
        const btn = input.closest('tr').querySelector('.btn-danger');
        btn.setAttribute('onclick', `adminStackDel('${newKey}')`);
        input.closest('tr').dataset.key = newKey;
        
        document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function adminStackSetMax(k,v){ stackingRules[k].max = v; runStackQuery(); }
    function adminStackSetOpt(k,v){ 
        const newOpts = {};
        v.split(',').forEach(pair => {
            const [rng, val] = pair.split(':');
            if(rng && val) newOpts[rng.trim()] = parseInt(val.trim()) || val.trim();
        });
        stackingRules[k].options = newOpts;
        updateStackThickList();
    }
    function adminStackAdd(){
        const k = prompt("è«‹è¼¸å…¥è¦å‰‡åç¨± (ä¾‹å¦‚ 25.0 (0.70))");
        if(!k || stackingRules[k]) return;
        stackingRules[k] = { max: "0", options: {"1~10":1} };
        adminStackRefresh();
        document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
    }
    function adminStackDel(k){
        if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
        delete stackingRules[k];
        adminStackRefresh();
        document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
    }

    // --- Admin: Tab 3 (Fine) ---
    function adminFineRefresh(){
        const tbody = document.getElementById('adminBody-fine');
        tbody.innerHTML = '';
        fineCutData.forEach((d, idx) => {
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.idx = idx;
            const cell = (field, sub, w) => `<input class="admin-input" style="width:${w||'60px'}" value="${d[field][sub]}" onchange="adminFineSet(${idx},'${field}',${sub},this.value)">`;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td><input class="admin-input" value="${d.label}" onchange="adminFineSetLabel(${idx},this.value)" style="width:120px;"></td>
                <td><input class="admin-input" value="${d.color}" onchange="adminFineSetColor(${idx},this.value)" style="width:80px;"></td>
                <td>${cell('s',0)} / ${cell('s',1)}</td>
                <td>${cell('f',0)} / ${cell('f',1)}</td>
                <td>${cell('t',0)} / ${cell('t',1)}</td>
                <td>${cell('d',0)} / ${cell('d',1)}</td>
                <td><button class="btn btn-danger" onclick="adminFineDel(${idx})">åˆª</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-fine', adminFineReorder);
    }
    
    function adminFineReorder(){
        const tbody = document.getElementById('adminBody-fine');
        const rows = [...tbody.querySelectorAll('tr')];
        const newArr = [];
        rows.forEach(r => {
            newArr.push(fineCutData[parseInt(r.dataset.idx)]);
        });
        fineCutData = newArr;
        updateFineSel();
        adminFineRefresh();
    }

    function adminFineSet(i,f,s,v){ fineCutData[i][f][s] = v; runFineQuery(); }
    function adminFineSetLabel(i,v){ fineCutData[i].label = v; updateFineSel(); }
    function adminFineSetColor(i,v){ fineCutData[i].color = v; runFineQuery(); }
    function updateFineSel(){ document.getElementById('fineSizeSel').innerHTML = fineCutData.map((d, i) => `<option value="${i}">${d.label}</option>`).join(''); }
    function adminFineAdd(){
        fineCutData.push({ label: "æ–°è¦å‰‡", s:["0","0"], f:["0","0"], t:["0","0"], d:["0","0"], color:"ç™½è‰²" });
        updateFineSel(); adminFineRefresh();
    }
    function adminFineDel(i){
        if(!confirm('åˆªé™¤æ­¤åˆ—ï¼Ÿ')) return;
        fineCutData.splice(i,1);
        updateFineSel(); adminFineRefresh();
    }

    // --- Admin: Tab 4 (Feed) ---
    function adminFeedRefresh(){
        const tbody = document.getElementById('adminBody-feed');
        tbody.innerHTML = '';
        feedData.forEach((d, idx) => {
            const cell = (field, sub) => `<input class="admin-input" style="width:50px" value="${d[field][sub]}" onchange="adminFeedSet(${idx},'${field}',${sub},this.value)">`;
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.idx = idx;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td><input class="admin-input" value="${d.label}" onchange="adminFeedSetLabel(${idx},this.value)" style="width:120px;"></td>
                <td>${cell('s',0)} / ${cell('s',1)}</td>
                <td>${cell('pF',0)} / ${cell('pF',1)}</td>
                <td>${cell('sF',0)} / ${cell('sF',1)}</td>
                <td><input class="admin-input" value="${d.life}" onchange="adminFeedSetLife(${idx},this.value)" style="width:50px;"></td>
                <td><button class="btn btn-danger" onclick="adminFeedDel(${idx})">åˆª</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-feed', adminFeedReorder);
    }
    
    function adminFeedReorder(){
        const tbody = document.getElementById('adminBody-feed');
        const rows = [...tbody.querySelectorAll('tr')];
        const newArr = [];
        rows.forEach(r => {
            newArr.push(feedData[parseInt(r.dataset.idx)]);
        });
        feedData = newArr;
        updateFeedSel();
        adminFeedRefresh();
    }

    function adminFeedSet(i,f,s,v){ feedData[i][f][s] = v; runFeedQuery(); }
    function adminFeedSetLabel(i,v){ feedData[i].label = v; updateFeedSel(); }
    function adminFeedSetLife(i,v){ feedData[i].life = v; runFeedQuery(); }
    function updateFeedSel(){ document.getElementById('feedSizeSel').innerHTML = feedData.map((d, i) => `<option value="${i}">${d.label}</option>`).join(''); }
    function adminFeedAdd(){
        feedData.push({ label: "æ–°ç¯„åœ", s:["0","0"], pF:["0","0"], sF:["0","0"], life: "1500" });
        updateFeedSel(); adminFeedRefresh();
    }
    function adminFeedDel(i){
        if(!confirm('åˆªé™¤ï¼Ÿ')) return;
        feedData.splice(i,1);
        updateFeedSel(); adminFeedRefresh();
    }

    // --- Admin: Tab 5 (Life) ---
    function adminLifeRefreshPanel(){
        const tbody = document.getElementById('adminBody-life');
        if(!tbody) return;
        const sizeKey = document.getElementById('lifeSizeSel').value;
        if(!sizeKey || !toolLifeRules[sizeKey]) { tbody.innerHTML = '<tr><td colspan="7">è«‹é¸æ“‡ç›´å¾‘</td></tr>'; return; }
        
        tbody.innerHTML = '';
        Object.keys(toolLifeRules[sizeKey]).forEach(t => {
            const d = toolLifeRules[sizeKey][t]; 
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.key = t;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td style="font-weight:bold;">${t}</td>
                <td><input class="admin-input" value="${d[0][0]}" onchange="adminLifeSet('${sizeKey}','${t}',0,0,this.value)"></td>
                <td><input class="admin-input" value="${d[0][1]}" onchange="adminLifeSet('${sizeKey}','${t}',0,1,this.value)"></td>
                <td><input class="admin-input" value="${d[1][0]}" onchange="adminLifeSet('${sizeKey}','${t}',1,0,this.value)"></td>
                <td><input class="admin-input" value="${d[1][1]}" onchange="adminLifeSet('${sizeKey}','${t}',1,1,this.value)"></td>
                <td><button class="btn btn-danger" onclick="adminLifeDeleteType('${sizeKey}','${t}')">åˆªé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-life', adminLifeReorder);
    }
    
    function adminLifeReorder() {
        const sizeKey = document.getElementById('lifeSizeSel').value;
        const tbody = document.getElementById('adminBody-life');
        const rows = [...tbody.querySelectorAll('tr')];
        const newObj = {};
        rows.forEach(r => {
            const k = r.dataset.key;
            if(toolLifeRules[sizeKey][k]) newObj[k] = toolLifeRules[sizeKey][k];
        });
        toolLifeRules[sizeKey] = newObj;
        updateLifeTypeList();
    }

    function adminLifeSet(s,t,side,idx,v){
        toolLifeRules[s][t][side][idx] = v;
        runLifeQuery();
    }
    function adminLifeAddSize(){
        const s = prompt('è¼¸å…¥æ–°ç›´å¾‘ (ä¾‹: 0.118")');
        if(!s || toolLifeRules[s]) return;
        toolLifeRules[s] = {};
        const sel = document.getElementById('lifeSizeSel');
        setSelectOptions(sel, Object.keys(toolLifeRules));
        sel.value = s;
        updateLifeTypeList();
    }
    function adminLifeDeleteSize(){
        const s = document.getElementById('lifeSizeSel').value;
        if(!confirm('åˆªé™¤ç›´å¾‘ '+s+' ?')) return;
        delete toolLifeRules[s];
        const sel = document.getElementById('lifeSizeSel');
        setSelectOptions(sel, Object.keys(toolLifeRules));
        updateLifeTypeList();
    }
    function adminLifeAddType(){
        const s = document.getElementById('lifeSizeSel').value;
        const t = prompt('è¼¸å…¥å‹æ…‹ (ä¾‹: ç‰¹æ®Šåˆ€)');
        if(!t) return;
        toolLifeRules[s][t] = [["0","0"],["0","0"]];
        adminLifeRefreshPanel();
        updateLifeTypeList();
    }
    function adminLifeDeleteType(s,t){
        if(!confirm('åˆªé™¤ '+t+' ?')) return;
        delete toolLifeRules[s][t];
        adminLifeRefreshPanel();
        updateLifeTypeList();
    }

    // ç›´å¾‘æ’åº
    function adminLifeOpenReorder() {
        const tbody = document.getElementById('reorderTbody');
        tbody.innerHTML = '';
        Object.keys(toolLifeRules).forEach(k => {
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.dataset.key = k;
            tr.innerHTML = `<td class="drag-handle">â˜°</td><td style="font-weight:bold; text-align:left;">${k}</td>`;
            tbody.appendChild(tr);
        });
        makeSortable('reorderTbody');
        document.getElementById('reorderModal').style.display = 'flex';
    }

    function adminLifeSaveOrder() {
        const rows = document.querySelectorAll('#reorderTbody tr');
        const newRules = {};
        rows.forEach(r => {
            const k = r.dataset.key;
            if(toolLifeRules[k]) newRules[k] = toolLifeRules[k];
        });
        Object.keys(toolLifeRules).forEach(k => {
            if(!newRules[k]) newRules[k] = toolLifeRules[k];
        });
        toolLifeRules = newRules;
        
        const sel = document.getElementById('lifeSizeSel');
        const currentVal = sel.value;
        setSelectOptions(sel, Object.keys(toolLifeRules));
        if(newRules[currentVal]) sel.value = currentVal;
        else if(Object.keys(newRules).length > 0) sel.value = Object.keys(newRules)[0];
        
        updateLifeTypeList();
        document.getElementById('reorderModal').style.display = 'none';
        alert('ç›´å¾‘é †åºå·²æ›´æ–°ï¼');
    }

    // --- Admin: Tab 6 (Note) ---
    function adminNoteRefresh(){
        const tbody = document.getElementById('adminBody-note');
        tbody.innerHTML = '';
        notesData.forEach((txt, idx) => {
            const tr = document.createElement('tr');
            tr.setAttribute('draggable', 'true');
            tr.dataset.idx = idx;
            tr.innerHTML = `
                <td class="drag-handle">â˜°</td>
                <td>${idx+1}</td>
                <td><input class="admin-input" value="${txt}" onchange="adminNoteSet(${idx},this.value)" style="width:100%;"></td>
                <td><button class="btn btn-danger" onclick="adminNoteDel(${idx})">åˆª</button></td>
            `;
            tbody.appendChild(tr);
        });
        makeSortable('adminBody-note', adminNoteReorder);
    }
    
    function adminNoteReorder(){
        const tbody = document.getElementById('adminBody-note');
        const rows = [...tbody.querySelectorAll('tr')];
        const newArr = [];
        rows.forEach(r => {
            newArr.push(notesData[parseInt(r.dataset.idx)]);
        });
        notesData = newArr;
        renderNotes();
        adminNoteRefresh();
    }

    function adminNoteSet(i,v){ notesData[i] = v; renderNotes(); }
    function adminNoteAdd(){ notesData.push("æ–°å‚™è¨»äº‹é …"); adminNoteRefresh(); renderNotes(); }
    function adminNoteDel(i){ notesData.splice(i,1); adminNoteRefresh(); renderNotes(); }


    // --- Persistence & Utils ---
    const STORAGE_KEY = 'rt_param_bundle_v7_final_fix'; 
    const STORAGE_VERDATE_KEY = 'rt_param_version_date_v7';

    function getBundle(){ return { toolData, stackingRules, fineCutData, feedData, toolLifeRules, notesData }; }
    function setBundle(b){
        if(!b) return;
        if(b.toolData) toolData = b.toolData;
        if(b.stackingRules) stackingRules = b.stackingRules;
        if(b.fineCutData) fineCutData = b.fineCutData;
        if(b.feedData) feedData = b.feedData;
        if(b.toolLifeRules) toolLifeRules = b.toolLifeRules;
        if(b.notesData) notesData = b.notesData;
    }
    function loadFromStorage(){
        try{
            const raw = localStorage.getItem(STORAGE_KEY);
            if(raw) setBundle(JSON.parse(raw));
            const vd = localStorage.getItem(STORAGE_VERDATE_KEY);
            if(vd) document.getElementById('verDate').value = vd;
        }catch(e){ console.warn(e); }
    }
    function saveAllChanges(){
        const vd = document.getElementById('verDate').value;
        if(!vd) { alert('è«‹å¡«å¯«æ›´æ–°ç‰ˆæœ¬æ—¥æœŸ'); return; }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(getBundle()));
        localStorage.setItem(STORAGE_VERDATE_KEY, vd);
        alert('å·²æš«å­˜åˆ°æœ¬æ©Ÿï¼');
    }
    function openAdvancedEditor(){
        document.getElementById('adminJson').value = JSON.stringify(getBundle(), null, 2);
        document.getElementById('adminModalBackdrop').style.display = 'flex';
    }
    function closeAdminModal(){ document.getElementById('adminModalBackdrop').style.display = 'none'; }
    function applyJsonChanges(){
        try{
            setBundle(JSON.parse(document.getElementById('adminJson').value));
            // Refresh All UI
            document.getElementById('typeSelect').innerHTML = `<optgroup label="ä¸»è¦å·¥åº"><option value="FF">ç²—åˆ‡ (FF)</option><option value="AA">ç²—åˆ‡ (AA) æ¸…ç²‰</option><option value="RD">å…§æ§½ (RD)ã€é˜»æŠ—æ¢ (CP)</option><option value="G42">å°é–‰æ§½ã€äºŒæ¬¡å­”ã€è€³æœµæ§½ã€è‘«è˜†å­”ã€é‡‘æ‰‹æŒ‡ (G42)</option><option value="OR">å¤–å‹ (OR)ã€è£é–‹ (HA)</option></optgroup><optgroup label="ç‰¹æ®Šå·¥åº"><option value="RDL">å…§æ§½ (RDL) é€†è½‰åˆ€</option><option value="DA">å°å¼•å­” (DA)</option><option value="DAFF">ç²—åˆ‡å°å¼•å­” (DA FF)</option></optgroup>`;
            updateSizeList();
            document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
            updateStackThickList();
            updateFineSel(); runFineQuery();
            updateFeedSel(); runFeedQuery();
            setSelectOptions(document.getElementById('lifeSizeSel'), Object.keys(toolLifeRules));
            updateLifeTypeList();
            renderNotes();
            adminRefreshAll();
            closeAdminModal();
            alert('è®Šæ›´å·²å¥—ç”¨ (è«‹è¨˜å¾—ä¿å­˜)');
        }catch(e){ alert('JSON éŒ¯èª¤: '+e.message); }
    }

    // --- NEW: Download Updated HTML ---
    function downloadUpdatedHtml() {
        let html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
        
        // å°‡è¨˜æ†¶é«”ä¸­æœ€æ–°çš„è³‡æ–™å¯«å› HTML åŸå§‹ç¢¼å­—ä¸²
        html = html.replace(/let toolData = \{[\s\S]*?\};/, `let toolData = ${JSON.stringify(toolData)};`);
        html = html.replace(/let stackingRules = \{[\s\S]*?\};/, `let stackingRules = ${JSON.stringify(stackingRules)};`);
        html = html.replace(/let fineCutData = \[[\s\S]*?\];/, `let fineCutData = ${JSON.stringify(fineCutData)};`);
        html = html.replace(/let feedData = \[[\s\S]*?\];/, `let feedData = ${JSON.stringify(feedData)};`);
        html = html.replace(/let toolLifeRules = \{[\s\S]*?\};/, `let toolLifeRules = ${JSON.stringify(toolLifeRules)};`);
        html = html.replace(/let notesData = \[[\s\S]*?\];/, `let notesData = ${JSON.stringify(notesData)};`);
        
        // é‡ç½®ä»‹é¢ç‹€æ…‹ (éš±è—ç®¡ç†é¢æ¿)ï¼Œç¢ºä¿ä¸‹è¼‰å¾Œçš„æª”æ¡ˆé–‹å•Ÿæ™‚æ˜¯ä¹¾æ·¨çš„æª¢è¦–æ¨¡å¼
        // 1. éš±è—æ‰€æœ‰ active çš„ admin-panel
        html = html.replace(/class="admin-panel\s+active"/g, 'class="admin-panel" style="display:none;"');
        // 2. ç¢ºä¿ display: block çš„ panel ä¹Ÿè¢«éš±è—
        html = html.replace(/style="display:\s*block;"/g, 'style="display:none;"');
        // 3. éš±è— Admin Bar
        html = html.replace(/id="adminBar"\s+style="display:\s*flex;"/, 'id="adminBar" style="display: none;"');
        // 4. é‡ç½® Admin æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
        html = html.replace(/id="btnAdmin"\s+style="display:\s*none;"/, 'id="btnAdmin" style="display: block;"');
        html = html.replace(/id="btnExit"\s+style="display:\s*block;"/, 'id="btnExit" style="display: none;"');
        
        // å»ºç«‹ä¸‹è¼‰
        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        a.download = `RT_Param_Table_v${date}.html`;
        a.click();
    }

    // --- Mobile Picker ---
    let _pickerSelectId = null;
    function syncPickerButtons() {
        const s1 = document.getElementById('lifeSizeSel'), s2 = document.getElementById('lifeTypeSel');
        const b1 = document.getElementById('lifeSizeBtn'), b2 = document.getElementById('lifeTypeBtn');
        if (s1 && b1) b1.textContent = s1.options[s1.selectedIndex]?.textContent || 'è«‹é¸æ“‡';
        if (s2 && b2) b2.textContent = s2.options[s2.selectedIndex]?.textContent || 'è«‹é¸æ“‡';
    }
    function openPicker(sid, title) {
        if (!window.matchMedia('(max-width: 900px)').matches) return;
        const sel = document.getElementById(sid);
        _pickerSelectId = sid;
        document.getElementById('pickerTitle').textContent = title;
        const list = document.getElementById('pickerList');
        list.innerHTML = '';
        [...sel.options].forEach(opt => {
            const item = document.createElement('div');
            item.className = 'picker-item' + (opt.value === sel.value ? ' active' : '');
            item.textContent = opt.textContent;
            item.onclick = () => {
                sel.value = opt.value;
                sel.dispatchEvent(new Event('change'));
                closePicker();
            };
            list.appendChild(item);
        });
        document.getElementById('pickerModal').classList.remove('hidden');
    }
    function closePicker() { document.getElementById('pickerModal').classList.add('hidden'); _pickerSelectId = null; syncPickerButtons(); }

    window.onload = () => {
        loadFromStorage();
        // Init Tab 1
        document.getElementById('typeSelect').innerHTML = `<optgroup label="ä¸»è¦å·¥åº"><option value="FF">ç²—åˆ‡ (FF)</option><option value="AA">ç²—åˆ‡ (AA) æ¸…ç²‰</option><option value="RD">å…§æ§½ (RD)ã€é˜»æŠ—æ¢ (CP)</option><option value="G42">å°é–‰æ§½ã€äºŒæ¬¡å­”ã€è€³æœµæ§½ã€è‘«è˜†å­”ã€é‡‘æ‰‹æŒ‡ (G42)</option><option value="OR">å¤–å‹ (OR)ã€è£é–‹ (HA)</option></optgroup><optgroup label="ç‰¹æ®Šå·¥åº"><option value="RDL">å…§æ§½ (RDL) é€†è½‰åˆ€</option><option value="DA">å°å¼•å­” (DA)</option><option value="DAFF">ç²—åˆ‡å°å¼•å­” (DA FF)</option></optgroup>`;
        updateSizeList();
        // Init Tab 2
        document.getElementById('stkSizeSel').innerHTML = Object.keys(stackingRules).map(s => `<option value="${s}">${s}</option>`).join('');
        updateStackThickList();
        // Init Tab 3
        updateFineSel(); runFineQuery();
        // Init Tab 4
        updateFeedSel(); runFeedQuery();
        // Init Tab 5
        setSelectOptions(document.getElementById('lifeSizeSel'), Object.keys(toolLifeRules));
        updateLifeTypeList();
        // Init Tab 6
        renderNotes();
    };

    // Close sidebar on click outside
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        if (!window.matchMedia('(max-width: 900px)').matches) return;
        if (document.getElementById('pickerModal').classList.contains('hidden') === false) return;
        if (e.target.closest('select, input, button, .picker-btn')) return;
        if (!sidebar.contains(e.target) && !e.target.closest('.hamburger-btn')) sidebar.classList.add('collapsed');
    });

</script>
</body>
</html>
